# 基于Z-stack的RGBW彩灯控制deemo

- Z-stack版本：2.4.0-1.4.0
- 工程环境：IAR for 8051 v7.6.1
- 开发板：自制口袋实验箱

## 功能说明
- 2个灯终端，一个按键终端，一个传感器终端（光敏传感器AD采样），一个协调器负责和PC交互
- 按键控制灯开关
- 上位机控制灯的详细属性
- 传感器可自动控制灯亮暗

## 版本说明

### V1.0.1
- 详细功能
    - 1个灯终端，1个按键终端，1个AD采样光敏传感，1一个协调器负责和PC交互。
    - 按键控制灯开启和关闭，在RGB无初值时，亮度为180（满值255）三色均匀，有初值可以记忆RGB值。
    - 传感器可通过协调器传输光亮度和亮度等级到上位机，也可同时自动调控灯亮度。
    - 协调器可传输指定RGBW值对灯进行准确控制。
- 版本优势
    - 由原先凌乱的多工程合并为一个总的工程（IDE配置策略，宏定义配置的使用，不同的编译策略）
    - 在进一步理解网络层传输机制的基础上，使用绑定机制来灵活构建逻辑链路，对命令簇的使用让传输更加灵活。
    - 利用规范样例重构代码，使得代码的可读性和结构更加清晰。
- 更多问题
    - 绑定的方式仍为手动，低效，繁琐，预计在应用层可改用自动绑定方式，若被控制端数量上升，改用组播。
    - 代码中存在众多打印观察用的无用代码，下次可使用debuglevel形式重写，或功能稳定后删除。
    - 网络不稳定，终端连入后，若多次采用手动绑定操作，不知道什么原因会使设备掉线或者无法绑定。也可能是触碰供电线导致重启。
    - 部分控制操作存在逻辑BUG，传感器因设备问题突变为高亮度，灯处无初值时，就会产生灯被关闭，RGB=255，W可能为0也可能不为0，此时除非协调器给一个固定值刷新 RGB值，否则按键不起任何作用。
    - 灯光控制部分，解析函数过于笨重，控制PWM的方式采用定时器1的4路比较通道，不合适，应外加控制芯片来减少引脚数量消耗。
    - 传感器自动调光的逻辑应该更加人性化。
    - 灯颜色亮度切换不连贯，应由突变改为渐变。
    - 各个控制操作和被控制操作，应该更稳定，这个版本中传感器对灯的自动调控很僵硬，按键控制也存在较大网络延迟（原因不明），绑定过程不稳定容易不成功，对灯的操作有冲突或者阻塞时，若继续操作，则绑定会失效（灯会不受控制），目标是一次自动组网，鲁棒性高，以极其可靠为最终目标。
    - 需优化各个部分执行的效率，在稳定的同时降低操作延迟。（网络链接方式、传输、控制和冗余操作是关注要点）
    - 灯终端数量过少，传感器数量过少，上位机没有较好的采集程序。
- 综合评价
    - 改进空间很大，目前只能适合于演示，实际使用不可行。